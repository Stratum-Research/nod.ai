#!/usr/bin/env node

/**
 * Simple setup script for macOS code signing and notarization
 * Run this once to configure your Apple Developer credentials
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { createInterface } from 'readline';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

console.log('\nðŸŽ macOS Code Signing & Notarization Setup\n');
console.log('This script will help you configure your Apple Developer credentials.\n');

// Check for existing certificates
console.log('Checking for Developer ID certificates...\n');
try {
  const certs = execSync('security find-identity -v -p codesigning', { encoding: 'utf-8' });
  const devIdCerts = certs.split('\n').filter(line => line.includes('Developer ID Application'));
  
  if (devIdCerts.length > 0) {
    console.log('âœ“ Found Developer ID certificates:\n');
    devIdCerts.forEach(cert => {
      const match = cert.match(/"([^"]+)"/);
      if (match) {
        console.log(`  â€¢ ${match[1]}`);
      }
    });
    console.log('\n');
  } else {
    console.log('âš  No Developer ID Application certificates found.\n');
    console.log('You need to create one at: https://developer.apple.com/account/resources/certificates/list\n');
    console.log('Steps:');
    console.log('  1. Go to Certificates, Identifiers & Profiles');
    console.log('  2. Click the "+" button');
    console.log('  3. Select "Developer ID Application"');
    console.log('  4. Download and double-click to install\n');
  }
} catch (error) {
  console.log('âš  Could not check certificates. Make sure you have a Developer ID certificate installed.\n');
}

// Check if .env already exists
const envPath = join(__dirname, '.env');
const envExamplePath = join(__dirname, '.env.example');

if (existsSync(envPath)) {
  console.log('âš  .env file already exists. I\'ll update it with your new values.\n');
}

// Get user input
console.log('I need 3 things from you:\n');
console.log('1. Your Apple Team ID (found at https://developer.apple.com/account/#/membership/)');
console.log('2. Your Apple ID email (the one you use for your developer account)');
console.log('3. An App-Specific Password (create at https://appleid.apple.com â†’ Sign-In and Security â†’ App-Specific Passwords)\n');

const readline = createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => readline.question(query, resolve));
}

async function main() {
  const teamId = await question('Apple Team ID: ');
  const appleId = await question('Apple ID email: ');
  const appSpecificPassword = await question('App-Specific Password: ');
  
  readline.close();
  
  // Find signing identity
  let identity = '';
  try {
    const certs = execSync('security find-identity -v -p codesigning', { encoding: 'utf-8' });
    const devIdCert = certs.split('\n').find(line => line.includes('Developer ID Application'));
    if (devIdCert) {
      const match = devIdCert.match(/"([^"]+)"/);
      if (match) {
        identity = match[1];
      }
    }
  } catch (error) {
    // Ignore
  }
  
  // Create .env file
  const envContent = `# Apple Developer credentials for code signing and notarization
# Generated by setup-macos-signing.js
# DO NOT COMMIT THIS FILE TO GIT

APPLE_TEAM_ID=${teamId.trim()}
APPLE_ID=${appleId.trim()}
APPLE_ID_PASS=${appSpecificPassword.trim()}
${identity ? `APPLE_IDENTITY=${identity}` : '# APPLE_IDENTITY=Developer ID Application: Your Name (TEAM_ID)'}
`;
  
  writeFileSync(envPath, envContent);
  console.log('\nâœ“ Configuration saved to .env file\n');
  
  // Create .env.example
  const envExampleContent = `# Apple Developer credentials for code signing and notarization
# Copy this file to .env and fill in your values
# Or run: node setup-macos-signing.js

APPLE_TEAM_ID=YOUR_TEAM_ID
APPLE_ID=your-apple-id@example.com
APPLE_ID_PASS=your-app-specific-password
APPLE_IDENTITY=Developer ID Application: Your Name (TEAM_ID)
`;
  
  writeFileSync(envExamplePath, envExampleContent);
  console.log('âœ“ Created .env.example file\n');
  
  console.log('ðŸŽ‰ Setup complete!\n');
  console.log('Now you can build and sign your app with:');
  console.log('  npm run build-electron\n');
  console.log('The build will automatically:');
  console.log('  â€¢ Sign your app with your Developer ID certificate');
  console.log('  â€¢ Notarize it with Apple');
  console.log('  â€¢ Create a signed DMG installer\n');
}

main().catch(console.error);

